const express = require("express");
const tr = require("tor-request");
const puppeteer = require('puppeteer');
const http = require("http");
const app = express();

const server = http.createServer(app);

tr.TorControlPort.password = "giraffe";

async function start()
{
    console.log("START!!!!");
    async function target() {
        const browser = await puppeteer.launch({
            headless: true,
            args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                `--proxy-server=socks5://127.0.0.1:9050`,
                '--disable-dev-shm-usage',
                '--disable-accelerated-2d-canvas',
                '--no-first-run',
                '--no-zygote',
                '--single-process',
                '--disable-gpu'
            ]
        });

        const page = await browser.newPage();

        page.goto("https://www.google.com")
        .then(() => {
            browser.close();
            renewIP();
            target();
        });
    }

    target();
}

function renewIP(){
    tr.renewTorSession(function(err, msg){
        if(err)
            console.log(err);
        else
            console.log(msg);
    });
}

app.get("/", (req, res) => {
    start();
});


const PORT = process.env.PORT;
server.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});